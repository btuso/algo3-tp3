\subsection{Heurística constructiva de cluster-first, route-second, clusterizando con algoritmo de Sweeping} \label{subsection:sweep}
\subsubsection{El algoritmo}
La solución al Problema de Enrutamiento de Vehículos con Capacidad mediante este algoritmo se divide en dos partes fundamentales: \textbf{1.} la clusterización y \textbf{2.} la búsqueda de un camino mínimo. La clusterización de los vértices de un grafo puede ser llevada a cabo de distintas maneras. En trabajos anteriores hemos utilizado el algoritmo de Kruskal y el algoritmo de Prim para obtener árboles generadores mínimos sobre los cuales se ejercían exploraciones vecinales y consecuentes podas hasta obtener una clusterización válida. Otros enfoques, por ejemplo, utilizan técnicas como la clusterización por $k-medians$ para agrupar nodos cercanos. Las alternativas son enormes. En este documento utilizamos el \textit{Sweep Clustering Algorithm} para producir los conjuntos de vértices euclidianamente cercanos.

\vskip 8pt

El concepto de \textit{sweeping} es fácil. Será conveniente distribuir los nodos en representación polar $(r, \theta)$ donde $r$ es la distancia del vértice al origen de coordenadas y $\theta$ el ángulo polar. De esta manera, – desde el nodo depósito – comenzamos proyectando un haz de luz y con él realizaremos un barrido en sentido anti-horario. Guardaremos en un conjunto todos los vértices que el haz vaya tocando hasta que la suma de todas sus demandas supere la capacidad de un camión. Cuando esto suceda, terminaremos de agregar elementos a este conjunto y crearemos otro donde seguiremos introduciendo nodos que se crucen con nuestro haz hasta volver a superar la capacidad máxima de un camión. Este procedimiento se sigue repitiendo hasta que no queden más nodos por asignar a un conjunto. Estos conjuntos \textbf{representan los clusters} y lo que estamos agrupando son \textbf{nodos angularmente cercanos entre sí} que \textbf{puedan ser satisfechos por un sólo camión}. Es decir, en nuestro esquema, satisfacer cada cluster será responsabilidad de uno y sólo un camión. Esta heurística pretende agrupar todos los clientes cercanos minimizando la distancia recorrida por los camiones. Es necesario notar que la forma final de los clusters tienden a tener un parecido natural a los pétalos de una flor. En general, las rutas con forma de pétalos son una característica geométrica muy común en las soluciones del Problema de Enrutamiento de Vehículos \textit{(Ryan et al. 1993a)}.

\vskip 8pt

Por último, ya sabemos qué vértices serán visitados por qué camiones, sin embargo, no sabemos en qué orden. Este problema es una instancia del \textbf{Problema del Viajante} y se decidió atacarla con \textbf{Nearest Neighbours Algorithm}, una heurística constructiva cuya solución fabrica de manera golosa que, como el nombre lo indica, consiste en visitar el vecino más cercano. A continuación procederemos a describir los pasos del algoritmo general:

\begin{description}
\item[Paso 1.] Polarización de las coordenadas cartesianas
\item[Paso 2.] Ordenamiento creciente de las coordenadas por sus ángulos polares
\item[Paso 3.] Averiguación del ángulo de \textit{menor densidad}
\item[Paso 4.] Ordenamiento creciente de las coordenadas por sus ángulos polares desde el \textit{ángulo de menor densidad}
\item[Paso 5.] Construcción de los \textit{clusters} mediante un \textit{sweeping} en sentido anti-horario
\item[Paso 6.] Aplicación de la heurística \textit{Nearest Neighbours} sobre cada cluster para la generación de rutas
\end{description}

Hay un detalle extra en la lógica de nuestro algoritmo llamado el \textbf{ángulo de menor densidad}. Para explicar esta medida, primer debemos explicar sus causas: en nuestro esquema inicial, planteamos un barrido de nodos para el armado de los \textit{clusters}. Lo que hemos omitido hasta ahora es que este barrido debe comenzar en algún lugar, o específicamente, un ángulo. Si no seleccionásemos cuidadosamente este ángulo y decidiésemos iniciar el barrido en un ángulo $\theta$, podría suceder que la solución óptima (que intentamos aproximar heurísticamente) contenga un cluster que es partido a la mitad por el haz proyectado desde el depósito en el ángulo $\theta$, y debido al movimiento natural del sweeping – es decir, antihorario – sólo se registre una mitad del cluster y no la otra que \textbf{hubiera quedado del lado horario} de $\theta$. Esto concluiría en la concepción de otro cluster distinto al óptimo y, en consecuencia, la posterior alteración del resto de la clusterización de los nodos. Por esta razón introducimos la noción de \textbf{sweeping adaptativo} que consiste en comenzar el barrido desde el ángulo \textbf{menos favorable} para la ocurriencia de estas falencias en nuestro algoritmo, pues minimiza la posibilidad de interrumpir (o atravezar) un cluster óptimo con nuestro haz al proyectarlo en un ángulo donde se deduce heurísticamente una baja densidad poblacional de nodos. Este ángulo es el ángulo de menor densidad y se entiende como el ángulo que atraviesa a la mitad \textbf{el espacio más grande entre dos vértices consecutivos} del grafo. En otras palabras, para calcular este ángulo encontramos la distancia más grande entre dos nodos angularmente consecutivos y comenzamos nuestro sweeping ahí. Si $\theta_{1}$ y $\theta_{2}$ son dos vértices consecutivos con la mayor separación angular del grafo donde $\theta_{1}$ es encontrado primero por el barrido, definimos como $\alpha$ el ángulo de menor densidad que equivale a:

\begin{center}
\begin{displaymath}
\alpha = \left\{
\begin{array}{l l}
			\alpha_{1} + \frac{|\alpha_{1} - \alpha_{2}|}{2} & \text{si }\alpha_{1} < \alpha_{2}\\
			\alpha_{1} + \frac{|2*\pi - \alpha_{1} + \alpha_{2}|}{2} & \text{sino}\\
\end{array}
\right.
\end{displaymath}
\end{center}

\subsubsection{Pseudo-código}
A continuación presentamos nuestras implementaciones con sus respectivas complejidades:

\input{sections/sweep/heuristica-cod-cvrp}
Esta función representa la globalidad de la heurística. Como fue mencionado en la introducción, el algoritmo comienza polarizando los puntos que inicialmente están representados en coordenadas cartesianas. Esto se realiza en $\bigO(n)$ pues se deben iterar todos los nodos en el grafo y, a partir de sus coordenadas $x$ e $y$, calcular sus valores polares y radiales. Luego, como cada vértice ya está polarizado, podemos ordenar cada uno por su cercanía al ángulo $0$ en radianes.

\input{sections/sweep/heuristica-cod-findsweepangle}
Ahora que sabemos qué vértice viene después de cuál en el barrido, averiguamos en qué ángulo debemos iniciar el \textit{sweep}. Esto lo hacemos en $\Theta(n)$ porque comparamos todos los vértices con su siguiente. Es importante notar el manejo del caso borde cuando se compara el vértice último vértice de la lista con el primero, pues si bien euclidianamente pueden estar casi al lado, al examinar sus ángulos podemos ver una diferencia enorme (pues el que esté por encima del eje $x$ tendrá un ángulo cercano a $0$, pero el que esté por debajo, a $2$). Esta situación se da cuando el primer vértice en el recorrido del \textit{sweep} tiene un ángulo mayor al segundo vértice detectado. Luego del cálculo, estamos en condiciones de generar los clusters porque ya disponemos del ángulo de inicio del barrido.

\input{sections/sweep/heuristica-cod-buildclusters}
Aquí es donde se realiza el barrido cuyo costo asintótico temporal es exactamente $\Theta(n)$ porque – devuelta – se recorren todos los nodos. Aquí es donde sucede la distribución de vértices a clusters tal que todos los vértices en un cluster son: \textbf{(a)} angularmente consecutivos y \textbf{(b)} satisfacibles por un sólo camión, como ya fue explicado en la introducción al algoritmo.

\input{sections/sweep/heuristica-cod-buildroutes}
La complejidad de este algoritmo es $\bigO(n^2*log(n))$ se iteran todos los vértices contenidos en todos los clusters que da una suma total de $n$ nodos pues no hay vértices que no esten en el grafo y la totalidad de los nodos está distribuida en los clusters. Luego, como \textbf{ExtraerVérticeMásCercanoA} tiene complejidad $\bigO(n*log(n))$ y se ejecuta $n$ veces, la complejidad final es la propuesta.

\input{sections/sweep/heuristica-cod-popclosestvertex}
Finalmente, la función \textbf{ExtraerVérticeMásCercanoA} toma un cluster y un punto, ordena decrecientemente el cluster por distancia euclideana a $punto$, toma el último elemento de la lista (es decir, el más cercano a $punto$) y lo retorna sin no antes eliminarlo de la lista en $\bigO(1)$ porque es el último elemento de la lista. La complejidad de esta función queda definida por el ordenamiento $\bigO(n*log(n))$ de la lista en la línea $2$.

\subsubsection{Instancias con soluciones no óptimas}
Este algoritmo posee al menos dos falencias que pueden producir soluciones de deslucida calidad. A continuación las repasamos:

\subsubsubsection{El algoritmo de \textit{sweeping} no prevee el agotamiento de stock}
A medida que un cluster se va construyendo, la capacidad del camión que atenderá los clientes de este conjunto se va agotando, es decir, la sumatoria de las demandas de todos los clientes en el cluster se va aproximando al valor de la capacidad máxima de los camiones. En estos casos, sería ideal emprender la vuelta hacia el depósito con stock suficiente para satisfacer vértices en el camino. Una manera de entender este concepto es visualizar cada ruta como un pétalo, donde la punta del antófilo indica el comienzo del emprendimiento al depósito. De esta manera, se minimiza la distancia recorrida al volver al punto de inicio pero \textbf{satisfaciendo vértices en el proceso}. Desgraciadamente, el algoritmo es inconsciente de esta situación y, en el peor de los casos, puede agotar su stock muy lejos del depósito solamente por seguir a rajatabla la heurística de viajar al nodo angularmente más cercano, pagando una distancia muy alta para volver.

\vskip 8pt

Esta falencia puede ser mitigada con metaheurísticas como \textbf{Tabú Search} o \textbf{Annealing} a la hora de seleccionar el siguiente vértice a visitar, teniendo en cuenta el vecindario inmediato y la cantidad de stock sobrante en el camión.

\parindent0em
\begin{multicols}{2}[\columnsep2em]
		\includegraphics[width=0.48\textwidth]{sweep-A-n32-k5}
\columnbreak

	\begin{figure}[H]
		\caption{Circuito no óptimo en camino verde} \label{fig:sweep-A-n32-k5}
		\vskip 4pt
		En este ejemplo se puede ver claramente la aparición de un circuito en la ruta verde. Como ya fue explicado, este se debe a que el algoritmo de resolución del TSP busca los nodos inmediatamente más cercanos sin considerar otras alternativas (a priori más ineficientes) pero que a la larga resultan más óptimas. Al seguir a rajatabla la heurística de \textit{Nearest Neighbours}, se comete un error de \textit{tunnel view} y se ignoran alternativas más eficientes a la larga.
	\end{figure}
\end{multicols}

\subsubsubsection{La heurística de \textit{TSP} puede ser muy golosa con las distancias}
Debido a que el orden de los clientes en los clusters es resuelto a través de la heurística \textit{Nearest Neighbours} que consiste en visitar el nodo inmediatamente más cercano sobre el cual se está parado, se puede perder el panorama general y cometer decisiones costosas para la calidad de la solución final. El ejemplo más recurrente se ve en la presencia de rutas con bucles o \textit{firuletes}, pues se produce una ``ida y vuelta'' innecesaria con total de visitar el nodo más cercano posible. Esto podría ser evitado utilizado alguna metaheurística como Annealing o Tabú Search para decidir a qué vértice saltar o utilizar una técnica como Lambda Exchange para optimizar e intentar eliminar estas manifestaciones del problema descripto. Analizaremos este fenómeno gráficamente:

\begin{figure}[H]
	\centering
	\begin{minipage}{0.48\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{sweep-without-adaptative}
		\caption{\footnotesize Sweeping no adaptativo}
		\label{fig:sweep-without-adaptative}
	\end{minipage}%
	\hspace{0.03\textwidth}
	\begin{minipage}{0.48\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{sweep-with-adaptative}
		\caption{\footnotesize Sweeping adaptativo}
		\label{fig:sweep-with-adaptative}
	\end{minipage}%
\end{figure}

En la figura \ref{fig:sweep-with-adaptative} se puede observar una clusterización correcta de los vértices. Los nodos recorridos por el camión verde son cercanos entre sí y lo mismo sucede con los del camión rojo. En cambio, en la figura \ref{fig:sweep-without-adaptative}, se puede observar cómo los clusters se interponen entre sí debido a que se comenzó a barrer angularmente sobre ángulo $0$, interrumpiendo a la mitad la concepción de un cluster óptimo.

\begin{figure}[H]
	\centering
	\begin{minipage}{0.48\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{sweep-without-adaptative}
		\caption{\footnotesize Sweeping no adaptativo}
		\label{fig:big-sweep-without-adaptative-but-good}
	\end{minipage}%
	\hspace{0.03\textwidth}
	\begin{minipage}{0.48\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{sweep-with-adaptative}
		\caption{\footnotesize Sweeping adaptativo}
		\label{fig:big-sweep-with-adaptative}
	\end{minipage}%
\end{figure}
